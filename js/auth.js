// js/auth.js - Sistema de autentica√ß√£o CORRIGIDO
class SistemaAuth {
    constructor() {
        this.usuarioLogado = null;
        this.carregarUsuarioSalvo();
    }

    // Carregar usu√°rio do localStorage
    carregarUsuarioSalvo() {
        try {
            const usuarioSalvo = localStorage.getItem('usuarioLogado');
            if (usuarioSalvo) {
                this.usuarioLogado = JSON.parse(usuarioSalvo);
                console.log('‚úÖ Usu√°rio carregado do localStorage:', this.usuarioLogado.username);
            }
        } catch (error) {
            console.error('‚ùå Erro ao carregar usu√°rio:', error);
            this.usuarioLogado = null;
        }
        return this.usuarioLogado;
    }

    // Verificar autentica√ß√£o
    verificarAutenticacao() {
        return this.carregarUsuarioSalvo();
    }

    // Fazer login - VERS√ÉO CORRIGIDA
    async fazerLogin(username, senha) {
        try {
            console.log('üîê Tentando login para:', username);
            
            if (!username || !senha) {
                throw new Error('Usu√°rio e senha s√£o obrigat√≥rios');
            }

            // Gerar hash da senha (SEM SALT - igual ao banco)
            const senhaHash = await this.hashSenha(senha);
            console.log('üìã Hash gerado:', senhaHash);

            // Buscar usu√°rio no banco
            console.log('üîç Buscando usu√°rio no banco...');
            
            const { data: usuarios, error } = await supabase
                .from('sistema_usuarios')
                .select('*')
                .eq('username', username)
                .eq('ativo', true);

            if (error) {
                console.error('‚ùå Erro Supabase:', error);
                throw new Error('Erro de conex√£o com o banco de dados');
            }

            console.log('üìä Usu√°rios encontrados:', usuarios);

            if (!usuarios || usuarios.length === 0) {
                throw new Error('Usu√°rio n√£o encontrado ou inativo');
            }

            const usuario = usuarios[0];
            
            // Verificar senha
            console.log('üîç Comparando hashes:');
            console.log('   Banco:', usuario.senha_hash);
            console.log('   Local:', senhaHash);
            
            if (usuario.senha_hash !== senhaHash) {
                throw new Error('Senha incorreta');
            }

            // Login bem-sucedido
            this.usuarioLogado = {
                id: usuario.id,
                nome: usuario.nome,
                username: usuario.username,
                tipo: usuario.tipo,
                ativo: usuario.ativo
            };

            localStorage.setItem('usuarioLogado', JSON.stringify(this.usuarioLogado));
            console.log('‚úÖ Login realizado com sucesso!');
            
            return { 
                success: true, 
                usuario: this.usuarioLogado,
                message: 'Login realizado com sucesso!' 
            };

        } catch (error) {
            console.error('‚ùå Erro no login:', error);
            return { 
                success: false, 
                error: error.message || 'Erro desconhecido no login' 
            };
        }
    }

    // Fazer logout
    fazerLogout() {
        console.log('üö™ Fazendo logout...');
        this.usuarioLogado = null;
        localStorage.removeItem('usuarioLogado');
        window.location.href = 'login.html';
    }

    // Fun√ß√£o de hash CORRIGIDA (SEM SALT)
    async hashSenha(senha) {
        try {
            // USAR APENAS A SENHA - SEM SALT (para coincidir com o banco)
            const texto = senha;
            
            const encoder = new TextEncoder();
            const data = encoder.encode(texto);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
            return hashHex;
            
        } catch (error) {
            console.error('‚ùå Erro no hash:', error);
            // Fallback
            return btoa(senha);
        }
    }

    // Verificar se √© admin
    isAdmin() {
        return this.usuarioLogado && this.usuarioLogado.tipo === 'admin';
    }

    // Verificar autentica√ß√£o e redirecionar se necess√°rio
    requerAutenticacao() {
        if (!this.verificarAutenticacao()) {
            window.location.href = 'login.html';
            return false;
        }
        return true;
    }

    requerAdmin() {
        if (!this.requerAutenticacao()) return false;
        if (!this.isAdmin()) {
            alert('‚ùå Acesso restrito a administradores');
            window.location.href = 'index.html';
            return false;
        }
        return true;
    }
}

// Adicionar esta fun√ß√£o auxiliar ao auth.js (se n√£o existir)
async function hashSenha(senha) {
    try {
        const encoder = new TextEncoder();
        const data = encoder.encode(senha);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    } catch (error) {
        console.error('Erro ao gerar hash:', error);
        return btoa(senha);
    }
}

// Inst√¢ncia global
window.sistemaAuth = new SistemaAuth();