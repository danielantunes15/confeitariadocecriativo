<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios - Confeitaria Doces Criativos</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/relatorios.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="logo">Doces Criativos</h1>
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <nav class="nav" id="mainNav">
                    <a href="index.html" class="nav-link">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Vendas</span>
                    </a>
                    <a href="caixa-fechamento.html" class="nav-link">
                        <i class="fas fa-cash-register"></i>
                        <span>Caixa</span>
                    </a>
                    <a href="estoque.html" class="nav-link">
                        <i class="fas fa-boxes"></i>
                        <span>Estoque</span>
                    </a>
                    <a href="relatorios.html" class="nav-link active">
                        <i class="fas fa-chart-bar"></i>
                        <span>Relatórios</span>
                    </a>
                    <a href="administracao.html" class="nav-link">
                        <i class="fas fa-cog"></i>
                        <span>Administração</span>
                    </a>
                    <button id="logout-btn" class="btn-logout">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Sair</span>
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div id="alert-container"></div>
            
            <div id="loading" class="card">
                <div class="spinner"></div>
                <p style="text-align: center;">Carregando relatórios...</p>
            </div>

            <div id="content" style="display: none;">
                <!-- Filtros e Controles -->
                <div class="card">
                    <div class="filtros-header">
                        <h2>Relatórios e Analytics</h2>
                        <div class="filtros-controles">
                            <div class="filtro-group">
                                <label for="periodo">Período:</label>
                                <select id="periodo">
                                    <option value="hoje">Hoje</option>
                                    <option value="ontem">Ontem</option>
                                    <option value="semana" selected>Esta Semana</option>
                                    <option value="mes">Este Mês</option>
                                    <option value="trimestre">Este Trimestre</option>
                                    <option value="ano">Este Ano</option>
                                    <option value="personalizado">Personalizado</option>
                                </select>
                            </div>
                            
                            <div class="filtro-group" id="data-personalizada" style="display: none;">
                                <label for="data-inicio">De:</label>
                                <input type="date" id="data-inicio">
                                <label for="data-fim">Até:</label>
                                <input type="date" id="data-fim">
                            </div>
                            
                            <div class="filtro-group">
                                <label for="tipo-relatorio">Tipo de Relatório:</label>
                                <select id="tipo-relatorio">
                                    <option value="vendas">Vendas</option>
                                    <option value="financeiro">Financeiro</option>
                                    <option value="estoque">Estoque</option>
                                    <option value="produtos">Produtos Mais Vendidos</option>
                                    <option value="categorias">Vendas por Categoria</option>
                                </select>
                            </div>
                            
                            <button id="gerar-relatorio" class="btn btn-primary">
                                <i class="fas fa-refresh"></i> Atualizar
                            </button>
                            
                            <button id="exportar-pdf" class="btn btn-success">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Cards de Resumo -->
                <div class="resumo-cards">
                    <div class="resumo-card total-vendas">
                        <div class="resumo-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="resumo-info">
                            <h3>Total de Vendas</h3>
                            <span class="valor" id="total-vendas">R$ 0,00</span>
                            <span class="variacao" id="variacao-vendas">+0% vs período anterior</span>
                        </div>
                    </div>
                    
                    <div class="resumo-card ticket-medio">
                        <div class="resumo-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div class="resumo-info">
                            <h3>Ticket Médio</h3>
                            <span class="valor" id="ticket-medio">R$ 0,00</span>
                            <span class="variacao" id="variacao-ticket">+0% vs período anterior</span>
                        </div>
                    </div>
                    
                    <div class="resumo-card produtos-vendidos">
                        <div class="resumo-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="resumo-info">
                            <h3>Produtos Vendidos</h3>
                            <span class="valor" id="total-produtos">0</span>
                            <span class="variacao" id="variacao-produtos">+0% vs período anterior</span>
                        </div>
                    </div>
                    
                    <div class="resumo-card clientes">
                        <div class="resumo-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="resumo-info">
                            <h3>Vendas Realizadas</h3>
                            <span class="valor" id="total-clientes">0</span>
                            <span class="variacao" id="variacao-clientes">+0% vs período anterior</span>
                        </div>
                    </div>
                </div>

                <!-- Gráficos e Visualizações -->
                <div class="dashboard-grid">
                    <!-- Gráfico de Vendas ao Longo do Tempo -->
                    <div class="card chart-card">
                        <div class="card-header">
                            <h3>Vendas ao Longo do Tempo</h3>
                            <div class="chart-controls">
                                <select id="tipo-grafico-vendas">
                                    <option value="linha">Linha</option>
                                    <option value="barra">Barras</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <canvas id="vendasChart" height="300"></canvas>
                        </div>
                    </div>

                    <!-- Vendas por Forma de Pagamento -->
                    <div class="card chart-card">
                        <div class="card-header">
                            <h3>Vendas por Forma de Pagamento</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="pagamentosChart" height="300"></canvas>
                        </div>
                    </div>

                    <!-- Produtos Mais Vendidos -->
                    <div class="card chart-card">
                        <div class="card-header">
                            <h3>Top 10 Produtos Mais Vendidos</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="produtosChart" height="300"></canvas>
                        </div>
                    </div>

                    <!-- Vendas por Categoria -->
                    <div class="card chart-card">
                        <div class="card-header">
                            <h3>Vendas por Categoria</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="categoriasChart" height="300"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Tabelas Detalhadas -->
                <div class="tabelas-relatorios">
                    <!-- Tabela de Vendas Detalhadas -->
                    <div class="card">
                        <div class="card-header">
                            <h3>Vendas Detalhadas</h3>
                            <button id="exportar-vendas" class="btn btn-secondary btn-sm">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table id="tabela-vendas">
                                    <thead>
                                        <tr>
                                            <th>Data/Hora</th>
                                            <th>Cliente</th>
                                            <th>Itens</th>
                                            <th>Valor Total</th>
                                            <th>Forma Pagamento</th>
                                            <th>Vendedor</th>
                                        </tr>
                                    </thead>
                                    <tbody id="vendas-body">
                                        <tr>
                                            <td colspan="6" style="text-align: center;">Carregando vendas...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tabela de Performance de Produtos -->
                    <div class="card">
                        <div class="card-header">
                            <h3>Performance de Produtos</h3>
                            <button id="exportar-produtos" class="btn btn-secondary btn-sm">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table id="tabela-produtos">
                                    <thead>
                                        <tr>
                                            <th>Produto</th>
                                            <th>Categoria</th>
                                            <th>Quantidade Vendida</th>
                                            <th>Valor Total</th>
                                            <th>Ticket Médio</th>
                                            <th>% do Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="produtos-body">
                                        <tr>
                                            <td colspan="6" style="text-align: center;">Carregando produtos...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Relatório Financeiro -->
                <div class="card" id="relatorio-financeiro">
                    <div class="card-header">
                        <h3>Relatório Financeiro Consolidado</h3>
                        <button id="exportar-financeiro" class="btn btn-success">
                            <i class="fas fa-file-pdf"></i> Exportar Relatório Completo
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="financeiro-grid">
                            <div class="financeiro-item">
                                <h4>Receitas</h4>
                                <div class="financeiro-detalhes">
                                    <div class="detalhe-item">
                                        <span>Vendas em Dinheiro:</span>
                                        <strong id="receita-dinheiro">R$ 0,00</strong>
                                    </div>
                                    <div class="detalhe-item">
                                        <span>Vendas em Cartão:</span>
                                        <strong id="receita-cartao">R$ 0,00</strong>
                                    </div>
                                    <div class="detalhe-item">
                                        <span>Vendas em PIX:</span>
                                        <strong id="receita-pix">R$ 0,00</strong>
                                    </div>
                                    <div class="detalhe-item total">
                                        <span>Total de Receitas:</span>
                                        <strong id="total-receitas">R$ 0,00</strong>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="financeiro-item">
                                <h4>Indicadores de Performance</h4>
                                <div class="financeiro-detalhes">
                                    <div class="detalhe-item">
                                        <span>Ticket Médio:</span>
                                        <strong id="indicador-ticket">R$ 0,00</strong>
                                    </div>
                                    <div class="detalhe-item">
                                        <span>Vendas por Dia:</span>
                                        <strong id="vendas-dia">R$ 0,00</strong>
                                    </div>
                                    <div class="detalhe-item">
                                        <span>Produtos por Venda:</span>
                                        <strong id="produtos-venda">0,0</strong>
                                    </div>
                                    <div class="detalhe-item">
                                        <span>Dias com Vendas:</span>
                                        <strong id="dias-vendas">0</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="error-message" class="card" style="display: none;">
                <h2>Erro de Conexão</h2>
                <p>Não foi possível conectar ao banco de dados.</p>
                <button onclick="location.reload()" class="btn btn-primary">Tentar Novamente</button>
            </div>
        </div>
    </main>

    <!-- Scripts na ordem correta -->
    <script src="js/supabase-client.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/relatorios.js"></script>
    
    <script>
    // Script para o menu mobile (padronizado com outras páginas)
    document.addEventListener('DOMContentLoaded', function() {
        const menuToggle = document.getElementById('menuToggle');
        const mainNav = document.getElementById('mainNav');
        
        if (menuToggle && mainNav) {
            menuToggle.addEventListener('click', function() {
                mainNav.classList.toggle('show');
            });
        }
        
        // Fechar menu ao clicar fora
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.header-content') && mainNav.classList.contains('show')) {
                mainNav.classList.remove('show');
            }
        });

        // Logout padronizado
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('Deseja realmente sair do sistema?')) {
                    if (window.sistemaAuth) {
                        window.sistemaAuth.fazerLogout();
                    } else {
                        // Fallback
                        localStorage.removeItem('usuarioLogado');
                        window.location.href = 'login.html';
                    }
                }
            });
        }

        // Configurar data atual como padrão
        const hoje = new Date();
        document.getElementById('data-fim').value = hoje.toISOString().split('T')[0];
        
        const umaSemanaAtras = new Date(hoje);
        umaSemanaAtras.setDate(hoje.getDate() - 7);
        document.getElementById('data-inicio').value = umaSemanaAtras.toISOString().split('T')[0];
    });
    </script>
</body>
</html>